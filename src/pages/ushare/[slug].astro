---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { Header } from "../../components/layout/Header";
import Footer from "../../components/layout/Footer.astro";
import Container from "../../components/layout/Container.astro";
import ArticleHeader from "../../components/sections/ArticleHeader.astro";
import ArticleContent from "../../components/sections/ArticleContent.astro";
import OtherArticles from "../../components/sections/OtherArticles.astro";
import { fetchGraphQL } from "../../lib/graphql";
import { GET_POST_BY_SLUG, GET_POSTS_BY_CATEGORY } from "../../lib/queries";

export async function getStaticPaths() {
  const data = await fetchGraphQL<any>(GET_POSTS_BY_CATEGORY, {
    first: 100,
    category: "ushare",
  }).catch(() => null);

  const posts = data?.posts?.nodes || [];

  return posts.map((post: any) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const categorySlug = "ushare";
const categoryLabel = "Ushare";

// Fetch the post
const postData = await fetchGraphQL<any>(GET_POST_BY_SLUG, { slug }).catch(
  () => null,
);
const post = postData?.post;

if (!post) {
  return Astro.redirect("/404");
}

// Fetch other articles for sidebar
const otherData = await fetchGraphQL<any>(GET_POSTS_BY_CATEGORY, {
  first: 10,
  category: categorySlug,
}).catch(() => null);

const allPosts = otherData?.posts?.nodes || [];
const otherPosts = allPosts
  .filter((p: any) => p.slug !== slug)
  .sort(() => Math.random() - 0.5)
  .slice(0, 3);

const otherArticles = otherPosts.map((p: any) => ({
  title: p.title,
  image: p.featuredImage?.node?.sourceUrl,
  imageAlt: p.featuredImage?.node?.altText || "",
  href: `${categorySlug}/${p.slug}`,
}));

const breadcrumbs = [
  { label: categoryLabel, href: categorySlug },
  { label: post.title },
];
---

<BaseLayout
  title={post.title}
  description={post.excerpt?.replace(/<[^>]*>/g, "").slice(0, 160)}
  image={post.featuredImage?.node?.sourceUrl}
  type="article"
  publishedTime={post.date}
>
  <Header client:load slot="header" />

  <Container class="py-8">
    <div class="grid lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <ArticleHeader
          title={post.title}
          featuredImage={post.featuredImage?.node?.sourceUrl}
          featuredImageAlt={post.featuredImage?.node?.altText}
          date={post.date}
          breadcrumbs={breadcrumbs}
          category={categoryLabel}
        />

        <ArticleContent content={post.content} />
      </div>

      <!-- Sidebar -->
      <aside class="lg:col-span-1">
        {
          otherArticles.length > 0 && (
            <OtherArticles articles={otherArticles} class="sticky top-24" />
          )
        }
      </aside>
    </div>
  </Container>

  <Footer slot="footer" />
</BaseLayout>
