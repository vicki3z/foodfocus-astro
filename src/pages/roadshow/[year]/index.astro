---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { Header } from "../../../components/layout/Header";
import Footer from "../../../components/layout/Footer.astro";
import Container from "../../../components/layout/Container.astro";
import Breadcrumb from "../../../components/ui/Breadcrumb.astro";
import ArticleGrid from "../../../components/sections/ArticleGrid.astro";
import { YearSelector } from "../../../components/ui/YearSelector";
import { fetchGraphQL } from "../../../lib/graphql";
import { GET_ROADSHOWS, GET_EVENT_YEARS, GET_PAGE_BY_SLUG } from "../../../lib/queries";

const pageTitle = "Roadshow";
const pageSlug = "roadshow";

export async function getStaticPaths() {
  const [yearsData, pageData] = await Promise.all([
    fetchGraphQL<any>(GET_EVENT_YEARS).catch(() => null),
    fetchGraphQL<any>(GET_PAGE_BY_SLUG, { slug: "food-focus-thailand-roadshow" }).catch(() => null),
  ]);

  const availableYears = (yearsData?.eventYears?.nodes || [])
    .map((node: any) => parseInt(node.name))
    .sort((a: number, b: number) => b - a);

  const pageContent = pageData?.page?.content || "";

  // Prefetch items for each year in parallel
  const yearItemsMap = await Promise.all(
    availableYears.map(async (year: number) => {
      const data = await fetchGraphQL<any>(GET_ROADSHOWS, { yearSlug: String(year) }).catch(() => null);
      return { year, items: data?.eventYear?.roadshows?.nodes || [] };
    })
  );

  return availableYears.map((year: number) => {
    const yearData = yearItemsMap.find((d) => d.year === year);
    return {
      params: { year: String(year) },
      props: { year, availableYears, pageContent, items: yearData?.items || [] },
    };
  });
}

const { year, availableYears, pageContent, items } = Astro.props as any;
const currentYear = year;

const articles = items.map((item: any) => ({
  title: item.title,
  excerpt: item.postSummary?.summary || "",
  slug: item.slug,
  image: item.featuredImage?.node?.sourceUrl,
  imageAlt: item.featuredImage?.node?.altText || "",
  category: pageTitle,
}));

const breadcrumbs = [
  { label: "Events", href: "events" },
  { label: pageTitle, href: pageSlug },
  { label: String(currentYear) }
];
---

<BaseLayout
  title={`${pageTitle} ${currentYear}`}
  description="Dedicated to be the industry-focused platform for Food & Beverage Industry in Thailand, Being a part of the sustainable success of Thai Food & Beverage Industry, Food Focus Thailand Roadshow to provide knowledge to Food & Beverage entrepreneurs located in major cities in Thailand."
>
  <Header client:load slot="header" />

  <Container class="py-8">
    <!-- Breadcrumb -->
    <Breadcrumb items={breadcrumbs} class="mb-6" />

    <!-- Page Title -->
    <h1 class="text-3xl font-bold text-[var(--color-text-dark)] mb-4">
      {pageTitle} {currentYear}
    </h1>

    <!-- Page Content -->
    {
      pageContent && (
        <div class="mb-8 text-[var(--color-text-muted)]" set:html={pageContent} />
      )
    }

    <!-- Year Selector -->
    {
      availableYears.length > 0 && (
        <YearSelector
          years={availableYears.map(String)}
          defaultYear={String(currentYear)}
          baseHref={pageSlug}
          client:load
        />
      )
    }

    <!-- Articles Grid -->
    {
      articles.length > 0 ? (
        <ArticleGrid articles={articles} baseHref={`${pageSlug}/${currentYear}`} columns={3} />
      ) : (
        <p class="text-center text-[var(--color-text-muted)] py-12">
          No items found for {currentYear}.
        </p>
      )
    }
  </Container>

  <Footer slot="footer" />
</BaseLayout>
