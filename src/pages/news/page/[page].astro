---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { Header } from "../../../components/layout/Header";
import Footer from "../../../components/layout/Footer.astro";
import Container from "../../../components/layout/Container.astro";
import Breadcrumb from "../../../components/ui/Breadcrumb.astro";
import ArticleGrid from "../../../components/sections/ArticleGrid.astro";
import Pagination from "../../../components/ui/Pagination.astro";
import { fetchAllPaginated } from "../../../lib/graphql";
import { GET_POSTS_BY_CATEGORY } from "../../../lib/queries";

const pageTitle = "News";
const categorySlug = "news";

export async function getStaticPaths() {
  const ITEMS_PER_PAGE = 12;

  // Fetch all posts to calculate total pages
  const allPosts = await fetchAllPaginated<any>(
    GET_POSTS_BY_CATEGORY,
    { first: 100, category: 'news' },
    (data) => data?.posts?.nodes || [],
    (data) => ({
      hasNextPage: data?.posts?.pageInfo?.hasNextPage || false,
      endCursor: data?.posts?.pageInfo?.endCursor || null,
    })
  );

  const totalPages = Math.ceil(allPosts.length / ITEMS_PER_PAGE);

  // Generate paths for all pages
  return Array.from({ length: totalPages }, (_, i) => {
    const page = i + 1;
    const start = i * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const posts = allPosts.slice(start, end);

    return {
      params: { page: String(page) },
      props: {
        posts,
        currentPage: page,
        totalPages,
      },
    };
  });
}

const { posts, currentPage, totalPages } = Astro.props;

const articles = posts.map((post: any) => ({
  title: post.title,
  excerpt: post.excerpt,
  date: post.date,
  slug: post.slug,
  image: post.featuredImage?.node?.sourceUrl,
  imageAlt: post.featuredImage?.node?.altText || "",
  category: post.categories?.nodes?.[0]?.name || pageTitle,
}));

const breadcrumbs = [{ label: pageTitle, href: categorySlug }];
---

<BaseLayout title={`${pageTitle} - Page ${currentPage}`} description="Dedicated to be the industry-focused platform for Food & Beverage Industry in Thailand, discover more about the no. 1 leading industry-focused magazine for food & beverage from Food Focus Thailand">
  <Header client:load slot="header" />

  <Container class="py-8">
    <!-- Breadcrumb -->
    <Breadcrumb items={breadcrumbs} class="mb-6" />

    <!-- Page Title -->
    <h1 class="text-3xl font-bold text-[var(--color-text-dark)] mb-8">
      {pageTitle}
    </h1>

    <!-- Articles Grid -->
    {
      articles.length > 0 ? (
        <>
          <ArticleGrid articles={articles} baseHref="news" columns={3} />
          <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            baseHref="news"
          />
        </>
      ) : (
        <p class="text-center text-[var(--color-text-muted)] py-12">
          No articles found.
        </p>
      )
    }
  </Container>

  <Footer slot="footer" />
</BaseLayout>
