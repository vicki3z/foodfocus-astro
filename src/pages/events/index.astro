---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { Header } from "../../components/layout/Header";
import Footer from "../../components/layout/Footer.astro";
import Container from "../../components/layout/Container.astro";
import Breadcrumb from "../../components/ui/Breadcrumb.astro";
import ArticleCard from "../../components/ui/ArticleCard.astro";
import { fetchGraphQL } from "../../lib/graphql";
import {
  GET_LATEST_EVENTS,
} from "../../lib/queries";
import { getBaseUrl } from "../../lib/utils";

const pageTitle = "Latest Events";
const baseUrl = getBaseUrl();

// Get current year and month
const now = new Date();
const currentYear = now.getFullYear();
const currentMonth = now.toLocaleDateString("en-US", { month: "long" }).toLowerCase();

const latestYear = currentYear;

// Reset to start of day for accurate comparison (needed before parallel fetch)
now.setHours(0, 0, 0, 0);

// Fetch all event data in parallel
const latestEventsData = await fetchGraphQL<any>(GET_LATEST_EVENTS, { yearSlug: String(latestYear) }).catch(() => null);

const roadmaps = (latestEventsData?.eventYear?.roadmaps?.nodes || [])
  .slice(0, 3)
  .map((item: any) => ({
    title: item.title,
    slug: item.slug,
    date: item.date,
    image: item.featuredImage?.node?.sourceUrl,
    imageAlt: item.featuredImage?.node?.altText || "",
    excerpt: item.postSummary?.summary || "",
    category: "Roadmap",
  }));

const roadshows = (latestEventsData?.eventYear?.roadshows?.nodes || [])
  .slice(0, 3)
  .map((item: any) => ({
    title: item.title,
    slug: item.slug,
    date: item.date,
    image: item.featuredImage?.node?.sourceUrl,
    imageAlt: item.featuredImage?.node?.altText || "",
    excerpt: item.postSummary?.summary || "",
    category: "Roadshow",
  }));

const proseries = (latestEventsData?.eventYear?.proseries?.nodes || [])
  .slice(0, 3)
  .map((item: any) => ({
    title: item.title,
    slug: item.slug,
    image: item.featuredImage?.node?.sourceUrl,
    imageAlt: item.featuredImage?.node?.altText || "",
    excerpt: item.postSummary?.summary || "",
    category: "ProSeries",
  }));

const seminars = (latestEventsData?.eventYear?.seminars?.nodes || [])
  .slice(0, 3)
  .map((item: any) => ({
    title: item.title,
    slug: item.slug,
    image: item.featuredImage?.node?.sourceUrl,
    imageAlt: item.featuredImage?.node?.altText || "",
    excerpt: item.postSummary?.summary || "",
    category: "Seminar",
  }));

const breadcrumbs = [{ label: "Latest Events" }];
---

<BaseLayout
  title={pageTitle}
  description="Discover the latest events from Food Focus Thailand including roadmaps, roadshows, proseries, exclusive events, and exhibitions"
>
  <Header client:load slot="header" />

  <Container class="py-8">
    <!-- Breadcrumb -->
    <Breadcrumb items={breadcrumbs} class="mb-6" />

    <!-- Page Title -->
    <h1 class="text-3xl font-bold text-[var(--color-text-dark)] mb-8 capitalize">
      {pageTitle}
    </h1>

    <!-- FFT Roadmap Section -->
    <section class="mb-12">
      <div class="flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center mb-6">
        <h2 class="text-xl font-bold text-[var(--color-text-dark)] uppercase">
          FFT ROADMAP
        </h2>
        <a
          href={`${baseUrl}roadmap/${latestYear}`}
          class="px-4 py-2 text-sm font-medium text-[var(--color-text-dark)] bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:border-[var(--color-primary)] transition-colors"
        >
          See all
        </a>
      </div>
      {
        roadmaps.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {roadmaps.map((event: any) => (
              <ArticleCard
                image={event.image}
                imageAlt={event.imageAlt}
                category={event.category}
                title={event.title}
                excerpt={event.excerpt}
                date={event.date}
                href={`roadmap/${latestYear}/${event.slug}`}
                variant="vertical"
              />
            ))}
          </div>
        ) : (
          <p class="text-center text-[var(--color-text-muted)] py-8">
            No latest roadmap events available at the moment.
          </p>
        )
      }
    </section>

    <!-- FFT Roadshow Section -->
    <section class="mb-12">
      <div class="flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center mb-6">
        <h2 class="text-xl font-bold text-[var(--color-text-dark)] uppercase">
          FFT ROADSHOW
        </h2>
        <a
          href={`${baseUrl}roadshows/${latestYear}`}
          class="px-4 py-2 text-sm font-medium text-[var(--color-text-dark)] bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:border-[var(--color-primary)] transition-colors"
        >
          See all
        </a>
      </div>
      {
        roadshows.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {roadshows.map((event: any) => (
              <ArticleCard
                image={event.image}
                imageAlt={event.imageAlt}
                category={event.category}
                title={event.title}
                excerpt={event.excerpt}
                date={event.date}
                href={`roadshow/${latestYear}/${event.slug}`}
                variant="vertical"
              />
            ))}
          </div>
        ) : (
          <p class="text-center text-[var(--color-text-muted)] py-8">
            No latest roadshow events available at the moment.
          </p>
        )
      }
    </section>

    <!-- FFT ProSeries Section -->
    <section class="mb-12">
      <div class="flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center mb-6">
        <h2 class="text-xl font-bold text-[var(--color-text-dark)] uppercase">
          FFT PROSERIES
        </h2>
        <a
          href={`${baseUrl}proseries/${latestYear}`}
          class="px-4 py-2 text-sm font-medium text-[var(--color-text-dark)] bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:border-[var(--color-primary)] transition-colors"
        >
          See all
        </a>
      </div>
      {
        proseries.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {proseries.map((event: any) => (
              <ArticleCard
                image={event.image}
                imageAlt={event.imageAlt}
                category={event.category}
                title={event.title}
                excerpt={event.excerpt}
                date={event.date}
                href={`proseries/${latestYear}/${event.slug}`}
                variant="vertical"
              />
            ))}
          </div>
        ) : (
          <p class="text-center text-[var(--color-text-muted)] py-8">
            No latest proseries events available at the moment.
          </p>
        )
      }
    </section>

    <!-- Exclusive Event (Seminars) Section -->
    <section class="mb-12">
      <div class="flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center mb-6">
        <h2 class="text-xl font-bold text-[var(--color-text-dark)] uppercase">
          EXCLUSIVE EVENT
        </h2>
        <a
          href={`${baseUrl}seminars/${latestYear}`}
          class="px-4 py-2 text-sm font-medium text-[var(--color-text-dark)] bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:border-[var(--color-primary)] transition-colors"
        >
          See all
        </a>
      </div>
      {
        seminars.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {seminars.map((event: any) => (
              <ArticleCard
                image={event.image}
                imageAlt={event.imageAlt}
                category={event.category}
                title={event.title}
                excerpt={event.excerpt}
                date={event.date}
                href={`exclusive-events/${latestYear}/${event.slug}`}
                variant="vertical"
              />
            ))}
          </div>
        ) : (
          <p class="text-center text-[var(--color-text-muted)] py-8">
            No latest exclusive events available at the moment.
          </p>
        )
      }
    </section>

    <!-- Exhibition Section -->
    <section class="mb-12">
      <div class="flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center mb-6">
        <h2 class="text-xl font-bold text-[var(--color-text-dark)] uppercase">
          EXHIBITION
        </h2>
        <a
          href={`${baseUrl}exhibitions/${currentYear}/${currentMonth}`}
          class="px-4 py-2 text-sm font-medium text-[var(--color-text-dark)] bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:border-[var(--color-primary)] transition-colors"
        >
          See all
        </a>
      </div>
    </section>
  </Container>

  <Footer slot="footer" />
</BaseLayout>
