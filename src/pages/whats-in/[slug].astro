---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { Header } from "../../components/layout/Header";
import Footer from "../../components/layout/Footer.astro";
import Container from "../../components/layout/Container.astro";
import ArticleHeader from "../../components/sections/ArticleHeader.astro";
import ArticleContent from "../../components/sections/ArticleContent.astro";
import OtherArticles from "../../components/sections/OtherArticles.astro";
import { fetchGraphQL, fetchAllPaginated } from "../../lib/graphql";
import { GET_POST_BY_SLUG, GET_POSTS_BY_CATEGORY } from "../../lib/queries";

export async function getStaticPaths() {
  const posts = await fetchAllPaginated<any>(
    GET_POSTS_BY_CATEGORY,
    { first: 30, category: "whats-in" },
    (data) => data?.posts?.nodes || [],
    (data) => ({
      hasNextPage: data?.posts?.pageInfo?.hasNextPage || false,
      endCursor: data?.posts?.pageInfo?.endCursor || null,
    })
  );

  return posts.map((post: any) => ({
    params: { slug: post.slug },
    props: { allPosts: posts },
  }));
}

const { slug } = Astro.params;
const { allPosts } = Astro.props as any;
const categorySlug = "whats-in";
const categoryLabel = "What's In";

// Fetch the post content (not available in list query)
const postData = await fetchGraphQL<any>(GET_POST_BY_SLUG, { slug }).catch(
  () => null,
);
const post = postData?.post;

if (!post) {
  return Astro.redirect("/404");
}

// Use allPosts from props for sidebar instead of refetching
const otherPosts = allPosts
  .filter((p: any) => p.slug !== slug)
  .sort(() => Math.random() - 0.5)
  .slice(0, 3);

const otherArticles = otherPosts.map((p: any) => ({
  title: p.title,
  image: p.featuredImage?.node?.sourceUrl,
  imageAlt: p.featuredImage?.node?.altText || "",
  href: `${categorySlug}/${p.slug}`,
  excerpt: p.excerpt,
  category: categoryLabel,
}));

const breadcrumbs = [
  { label: categoryLabel, href: categorySlug },
  { label: post.title },
];
---

<BaseLayout
  title={`${post.title} - What's In`}
  description={post.excerpt?.replace(/<[^>]*>/g, "").slice(0, 160)}
  image={post.featuredImage?.node?.sourceUrl}
  type="article"
  publishedTime={post.date}
>
  <Header client:load slot="header" />

  <Container class="py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Main Content -->
      <div class="lg:flex-1 lg:w-2/3">
        <ArticleHeader
          title={post.title}
          featuredImage={post.featuredImage?.node?.sourceUrl}
          featuredImageAlt={post.featuredImage?.node?.altText}
          date={post.date}
          breadcrumbs={breadcrumbs}
          category={categoryLabel}
        />

        <ArticleContent content={post.content} />
      </div>

      <!-- Sidebar -->
      <aside class="lg:w-1/3">
        {otherArticles.length > 0 && <OtherArticles articles={otherArticles} />}
      </aside>
    </div>
  </Container>

  <Footer slot="footer" />
</BaseLayout>
