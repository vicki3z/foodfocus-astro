name: Deploy Astro site to FTP

# WordPress Webhook Setup:
# 1. Create a GitHub Personal Access Token (PAT) with 'repo' scope
# 2. In WordPress, configure webhook to POST to:
#    URL: https://api.github.com/repos/OWNER/REPO/dispatches
#    Headers: Authorization: token YOUR_GITHUB_PAT
#    Body: {"event_type": "wordpress_publish"}
# 3. Trigger on post publish/update events

on:
  # Trigger on push to main branch
  push:
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  # Trigger via WordPress webhook (repository_dispatch event)
  repository_dispatch:
    types: [wordpress_publish, wordpress_update]

# Concurrency control: Cancel in-progress runs when a new deployment is triggered
# This ensures only the latest content gets deployed, preventing conflicts
concurrency:
  group: "deploy-ftp"
  cancel-in-progress: true

env:
  BUILD_PATH: "."

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    environment: github-pages
    steps:
      - name: Log deployment trigger
        run: |
          echo "Deployment triggered by: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "Webhook action type: ${{ github.event.action }}"
          fi
          echo "Workflow run: ${{ github.run_id }}"
          echo "Commit: ${{ github.sha }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: ${{ env.BUILD_PATH }}/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install
        working-directory: ${{ env.BUILD_PATH }}

      - name: Build with Astro
        run: pnpm astro build
        working-directory: ${{ env.BUILD_PATH }}
        env:
          WP_GRAPHQL_URL: ${{ vars.WP_GRAPHQL_URL }}
          PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.PUBLIC_GOOGLE_MAPS_API_KEY }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: ./dist/
          retention-days: 1

  deploy-homepage:
    name: Deploy - Homepage & Resources
    needs: build
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./dist/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
            **/about-us/**
            **/contact-us/**
            **/events/**
            **/exclusive-events/**
            **/exhibitions/**
            **/magazines/**
            **/news/**
            **/proseries/**
            **/roadmap/**
            **/roadshow/**
            **/services/**
            **/ushare/**
            **/whats-in/**

  deploy-whats-in-1:
    name: Deploy - Whats In Articles (Batch 1/8, folders 1-400)
    needs: build
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./whats-in-batch/
          # Root-level files (whats-in index, pagination pages, etc.) go in batch 1
          find ./dist/whats-in/ -maxdepth 1 -type f -exec cp {} ./whats-in-batch/ \;
          # First 400 article subdirectories
          ls -1d ./dist/whats-in/*/ | sort | sed -n '1,400p' | while IFS= read -r dir; do
            cp -r "$dir" ./whats-in-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./whats-in-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/whats-in/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-whats-in-2:
    name: Deploy - Whats In Articles (Batch 2/8, folders 401-800)
    needs: build
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./whats-in-batch/
          ls -1d ./dist/whats-in/*/ | sort | sed -n '401,800p' | while IFS= read -r dir; do
            cp -r "$dir" ./whats-in-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./whats-in-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/whats-in/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-whats-in-3:
    name: Deploy - Whats In Articles (Batch 3/8, folders 801-1200)
    needs: [build, deploy-whats-in-1, deploy-whats-in-2]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./whats-in-batch/
          ls -1d ./dist/whats-in/*/ | sort | sed -n '801,1200p' | while IFS= read -r dir; do
            cp -r "$dir" ./whats-in-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./whats-in-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/whats-in/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-whats-in-4:
    name: Deploy - Whats In Articles (Batch 4/8, folders 1201-1600)
    needs: [build, deploy-whats-in-1, deploy-whats-in-2]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./whats-in-batch/
          ls -1d ./dist/whats-in/*/ | sort | sed -n '1201,1600p' | while IFS= read -r dir; do
            cp -r "$dir" ./whats-in-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./whats-in-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/whats-in/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-whats-in-5:
    name: Deploy - Whats In Articles (Batch 5/8, folders 1601-2000)
    needs: [build, deploy-whats-in-3, deploy-whats-in-4]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./whats-in-batch/
          ls -1d ./dist/whats-in/*/ | sort | sed -n '1601,2000p' | while IFS= read -r dir; do
            cp -r "$dir" ./whats-in-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./whats-in-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/whats-in/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-whats-in-6:
    name: Deploy - Whats In Articles (Batch 6/8, folders 2001-2400)
    needs: [build, deploy-whats-in-3, deploy-whats-in-4]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./whats-in-batch/
          ls -1d ./dist/whats-in/*/ | sort | sed -n '2001,2400p' | while IFS= read -r dir; do
            cp -r "$dir" ./whats-in-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./whats-in-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/whats-in/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-whats-in-7:
    name: Deploy - Whats In Articles (Batch 7/8, folders 2401-2800)
    needs: [build, deploy-whats-in-5, deploy-whats-in-6]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./whats-in-batch/
          ls -1d ./dist/whats-in/*/ | sort | sed -n '2401,2800p' | while IFS= read -r dir; do
            cp -r "$dir" ./whats-in-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./whats-in-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/whats-in/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-whats-in-8:
    name: Deploy - Whats In Articles (Batch 8/8, folders 2801+)
    needs: [build, deploy-whats-in-5, deploy-whats-in-6]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./whats-in-batch/
          ls -1d ./dist/whats-in/*/ | sort | tail -n +2801 | while IFS= read -r dir; do
            cp -r "$dir" ./whats-in-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./whats-in-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/whats-in/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-news-1:
    name: Deploy - News Articles (Batch 1/4, folders 1-400)
    needs: [build, deploy-whats-in-7, deploy-whats-in-8]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./news-batch/
          # Root-level files (news index, pagination pages, etc.) go in batch 1
          find ./dist/news/ -maxdepth 1 -type f -exec cp {} ./news-batch/ \;
          # First 400 article subdirectories
          ls -1d ./dist/news/*/ | sort | sed -n '1,400p' | while IFS= read -r dir; do
            cp -r "$dir" ./news-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./news-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/news/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-news-2:
    name: Deploy - News Articles (Batch 2/4, folders 401-800)
    needs: [build, deploy-whats-in-7, deploy-whats-in-8]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./news-batch/
          ls -1d ./dist/news/*/ | sort | sed -n '401,800p' | while IFS= read -r dir; do
            cp -r "$dir" ./news-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./news-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/news/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-news-3:
    name: Deploy - News Articles (Batch 3/4, folders 801-1200)
    needs: [build, deploy-news-1, deploy-news-2]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./news-batch/
          ls -1d ./dist/news/*/ | sort | sed -n '801,1200p' | while IFS= read -r dir; do
            cp -r "$dir" ./news-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./news-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/news/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-news-4:
    name: Deploy - News Articles (Batch 4/4, folders 1201+)
    needs: [build, deploy-news-1, deploy-news-2]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Prepare batch
        run: |
          mkdir -p ./news-batch/
          ls -1d ./dist/news/*/ | sort | tail -n +1201 | while IFS= read -r dir; do
            cp -r "$dir" ./news-batch/
          done

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./news-batch/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/news/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-ushare:
    name: Deploy - Ushare Articles
    needs: [build, deploy-news-3, deploy-news-4]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./dist/ushare/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/ushare/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store

  deploy-events-magazines:
    name: Deploy - Latest Events & Magazines
    needs: build
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./dist/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
            **/about-us/**
            **/contact-us/**
            **/_astro/**
            **/home/**
            **/fonts/**
            **/images/**
            **/news/**
            **/exclusive-events/2015/**
            **/exclusive-events/2016/**
            **/exclusive-events/2017/**
            **/exclusive-events/2018/**
            **/exclusive-events/2019/**
            **/exclusive-events/2020/**
            **/exclusive-events/2021/**
            **/exclusive-events/2022/**
            **/exclusive-events/2023/**
            **/exclusive-events/2024/**
            **/exclusive-events/2025/**
            **/exhibitions/2015/**
            **/exhibitions/2016/**
            **/exhibitions/2017/**
            **/exhibitions/2018/**
            **/exhibitions/2019/**
            **/exhibitions/2020/**
            **/exhibitions/2021/**
            **/exhibitions/2022/**
            **/exhibitions/2023/**
            **/exhibitions/2024/**
            **/exhibitions/2025/**
            **/proseries/2015/**
            **/proseries/2016/**
            **/proseries/2017/**
            **/proseries/2018/**
            **/proseries/2019/**
            **/proseries/2020/**
            **/proseries/2021/**
            **/proseries/2022/**
            **/proseries/2023/**
            **/proseries/2024/**
            **/proseries/2025/**
            **/roadmap/2015/**
            **/roadmap/2016/**
            **/roadmap/2017/**
            **/roadmap/2018/**
            **/roadmap/2019/**
            **/roadmap/2020/**
            **/roadmap/2021/**
            **/roadmap/2022/**
            **/roadmap/2023/**
            **/roadmap/2024/**
            **/roadmap/2025/**
            **/roadshow/2015/**
            **/roadshow/2016/**
            **/roadshow/2017/**
            **/roadshow/2018/**
            **/roadshow/2019/**
            **/roadshow/2020/**
            **/roadshow/2021/**
            **/roadshow/2022/**
            **/roadshow/2023/**
            **/roadshow/2024/**
            **/roadshow/2025/**
            **/ushare/**
            **/whats-in/**
            **/services/**
            **/index.html
            **/404.html
            **/.htaccess
            **/favicon.ico
            **/sitemap-*.xml

  deploy-static-pages:
    name: Deploy - Static Pages
    needs: [build, deploy-homepage]
    runs-on: ubuntu-latest
    environment: github-pages
    timeout-minutes: 20
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist/

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          log-level: verbose
          protocol: ftps
          port: 2002
          timeout: 1500000
          local-dir: ./dist/
          server-dir: ./domains/${{ secrets.FTP_DOMAIN }}/public_html/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
            **/_astro/**
            **/home/**
            **/fonts/**
            **/images/**
            **/events/**
            **/exclusive-events/**
            **/exhibitions/**
            **/magazines/**
            **/news/**
            **/proseries/**
            **/roadmap/**
            **/roadshow/**
            **/ushare/**
            **/whats-in/**
            **/index.html
            **/404.html
            **/.htaccess
            **/favicon.ico
            **/sitemap-*.xml
